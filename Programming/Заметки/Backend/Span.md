## **Что это такое**

  
Span(T) — это **тип-структура** для работы с **непрерывными областями памяти** (массивы, срезы массивов, буферы, указатели, стеки) **без выделений в куче** и с сохранением безопасности типов.

  
Особенности:

- ref struct → живёт только на стеке, нельзя хранить в поле класса или захватывать в лямбду.
    
- Поддерживает **срезы** (Slice) без копирования.
    
- Может указывать на **массив**, **часть массива**, **stackalloc-буфер**, **неуправляемую память**.
    
- Работает **только синхронно** (не может пересекать await).
    

---

## **Зачем нужно**

- Избежать лишних аллокаций (GC pressure).
    
- Эффективно обрабатывать данные (например, строки или бинарные буферы).
    
- Доступ к памяти через безопасный API.
    

---

## **Основные примеры**

  

### **1. Работа с массивом без копирования**

``` csharp
int[] numbers = { 1, 2, 3, 4, 5 };
Span<int> span = numbers;

// Создание среза (view на часть массива)
Span<int> slice = span.Slice(1, 3);

foreach (var n in slice)
{
    Console.WriteLine(n); // 2, 3, 4
}
```

### **2. Использование** 

### **stackalloc**

  

stackalloc выделяет память **в стеке** (а не в куче). Это полезно для временных буферов.

``` csharp
Span<int> stackSpan = stackalloc int[5];
for (int i = 0; i < stackSpan.Length; i++)
{
    stackSpan[i] = i * 10;
}

foreach (var n in stackSpan)
{
    Console.WriteLine(n); // 0, 10, 20, 30, 40
}
```

### **3. Работа со строками**

``` csharp
string text = "Hello World";
ReadOnlySpan<char> span = text;

// Срез "World"
ReadOnlySpan<char> slice = span.Slice(6, 5);
Console.WriteLine(slice.ToString()); // World
```

### **4. Передача в методы без аллокаций**

``` csharp
void Process(Span<int> data)
{
    for (int i = 0; i < data.Length; i++)
        data[i] *= 2;
}

int[] arr = { 1, 2, 3 };
Process(arr);
Console.WriteLine(string.Join(", ", arr)); // 2, 4, 6
```

---

## **Когда использовать** 

## **stackalloc**

- Для **малых временных буферов** (например, парсинг чисел, форматирование строк).
    
- Когда важна **максимальная производительность** и можно гарантировать небольшой размер.
    
- При выделении больших массивов в куче может быть дорого → stackalloc даёт быстрый доступ.
    

  

⚠️ Ограничения: стек ограничен (~1 МБ), поэтому stackalloc нельзя использовать для больших буферов.

---

## **Главное**

- Span(T) = быстрый, безопасный доступ к памяти **без лишних копирований**.
    
- ReadOnlySpan(T) — только для чтения.
    
- stackalloc + Span(T) = быстрые временные буферы без GC.
    
- Не хранится в куче, нельзя использовать асинхронно.
    

  

Используй Span(T) там, где нужна **максимальная производительность и минимизация аллокаций**.