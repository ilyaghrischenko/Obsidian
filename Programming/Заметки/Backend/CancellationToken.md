## **üßæ –ß—Ç–æ —Ç–∞–∫–æ–µ**¬†

## **CancellationToken**

  

CancellationToken ‚Äî —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º .NET, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π **–æ—Ç–º–µ–Ω—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ –∫–æ–º–∞–Ω–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤—Ä—É—á–Ω—É—é –∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—è –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å–∏–ª—å–Ω–æ.

  

–ü–æ–ª–µ–∑–µ–Ω –ø—Ä–∏:

- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    
- –û–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–º–µ–Ω—ã HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤, —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ —Ç.–¥.
    

---

## **üß† –û—Å–Ω–æ–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏**
|**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**|**–û–ø–∏—Å–∞–Ω–∏–µ**|
|---|---|
|CancellationToken|–¢–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –º–µ—Ç–æ–¥ –∏ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–± –æ—Ç–º–µ–Ω–µ|
|CancellationTokenSource|–ò—Å—Ç–æ—á–Ω–∏–∫, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Ç–æ–∫–µ–Ω–æ–º (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å .Cancel())|
|IsCancellationRequested|–ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–∞ –ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞|

---

## **üîß –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

``` csharp
public async Task DownloadDataAsync(CancellationToken token)
{
    for (int i = 0; i < 10; i++)
    {
        token.ThrowIfCancellationRequested(); // –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–∞

        Console.WriteLine($"–ó–∞–≥—Ä—É–∑–∫–∞ {i + 1}/10...");
        await Task.Delay(1000, token); // –≤–∞–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω
    }

    Console.WriteLine("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
}
```

### **–ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ —Å –æ—Ç–º–µ–Ω–æ–π:**

``` csharp
var cts = new CancellationTokenSource();

var task = DownloadDataAsync(cts.Token);

// –û—Ç–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
Task.Delay(3000).ContinueWith(_ => cts.Cancel());

await task;
```

## **‚ùó –í–∞–∂–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ —Å–≤–æ–π—Å—Ç–≤–∞**
|**–ú–µ—Ç–æ–¥ / –°–≤–æ–π—Å—Ç–≤–æ**|**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**|
|---|---|
|token.IsCancellationRequested|–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –ª–∏ –æ—Ç–º–µ–Ω–∞|
|token.ThrowIfCancellationRequested()|–í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç OperationCanceledException|
|token.Register(Action)|–í—ã–∑—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ|
|cts.Cancel()|–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É|
|cts.CancelAfter(ms)|–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è|
|using var cts = new CancellationTokenSource()|–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤|

## **üß¨ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å**¬†

## **Task**

``` csharp
await Task.Delay(5000, token); // –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å—Ä–∞–±–æ—Ç–∞–ª
```

## **üìå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ ASP.NET Core**

  

–í–æ –º–Ω–æ–≥–∏—Ö –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö ASP.NET Core, —Ç–∞–∫–∏—Ö –∫–∞–∫ Controller, [[FastEndpoints]], Minimal API, [[BackgroundService]], [[CQRS + Mediator]], –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ CancellationToken:

``` csharp
[HttpGet]
public async Task<IActionResult> GetData(CancellationToken cancellationToken)
{
    var data = await _dataService.LoadAsync(cancellationToken);
    return Ok(data);
}
```

## **üîÑ –ü—Ä–∏–º–µ—Ä –≤ BackgroundService**

``` csharp
protected override async Task ExecuteAsync(CancellationToken stoppingToken)
{
    while (!stoppingToken.IsCancellationRequested)
    {
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á—É
        await DoWorkAsync(stoppingToken);
    }
}
```

---

## **üõë –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏**

  

‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ThrowIfCancellationRequested() —Ç–∞–º, –≥–¥–µ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

‚úÖ –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ CancellationToken –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã (Task.Delay, HttpClient, [[Entity Framework Core]] –∏ —Ç.–¥.)

‚úÖ –í —Ñ–æ–Ω–æ–≤–æ–º —Å–µ—Ä–≤–∏—Å–µ –∏–ª–∏ –¥–æ–ª–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ö –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω

‚úÖ –ò–∑–±–µ–≥–∞–π—Ç–µ Thread.Sleep, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Task.Delay(..., token)

---

## **üß™ –ò—Ç–æ–≥**

  

CancellationToken ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è **–≥–∏–±–∫–æ–≥–æ, –æ—Ç–∑—ã–≤—á–∏–≤–æ–≥–æ –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ** –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞. –û–Ω –ø–æ–º–æ–≥–∞–µ—Ç:

- –∏–∑–±–µ–≥–∞—Ç—å –ø–æ–¥–≤–∏—Å–∞–Ω–∏–π
    
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–∞–¥–∞—á–∏
    
- —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã